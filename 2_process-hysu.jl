using CondaPkg
CondaPkg.add("numpy")
CondaPkg.add("tifffile")
using PythonCall
using HDF5
using MAT
using Images, ImageIO
import CairoMakie as cmk
using DataFrames, CSV

tifffile = pyimport("tifffile")

path_large_targets = "./data/hysu/original/HySpex/large_targets"
path_small_targets = "./data/hysu/original/HySpex/small_targets"
path_all_targets = "./data/hysu/original/HySpex/all_targets"
path_full = "./data/hysu/original/HySpex/full"

masks_path = joinpath(path_all_targets, "TargetsROIs", "Matlab", "masks.mat")

# all pixels in all_targets that include on the 6 classes
pixel_mask = .!(Bool.(load(joinpath(path_all_targets, "DLR_HySU_HS_all_targets_mask.png"))))

size(pixel_mask)

# load data from tiff files
X_large = tifffile.tifffile.imread(joinpath(path_large_targets, "DLR_HySU_HS_large_targets.tif"))
X_small = tifffile.tifffile.imread(joinpath(path_small_targets, "DLR_HySU_HS_small_targets.tif"))
X_all= tifffile.tifffile.imread(joinpath(path_all_targets, "DLR_HySU_HS_all_targets.tif"))
X_full = tifffile.tifffile.imread(joinpath(path_full, "DLR_HySU_HS_full.tif"))

# convert to Julia Array
X_large = pyconvert(Array, X_large);
X_small = pyconvert(Array, X_small);
X_all = pyconvert(Array, X_all);
X_full = pyconvert(Array, X_full);

# rescale to reflectance ∈ [0,1]
scale_fac = 10_000.0

X_large = X_large/scale_fac ;
X_small = X_small/scale_fac ;
X_all = X_all/scale_fac ;
X_full = X_full/scale_fac ;


# load in area masks for "all_targets"
masks = matread(masks_path)
masks

size(masks["materials"])
size(masks["targetsROI"])


size(X_large)
size(X_small)
size(X_all)

masks["materials"];

fig0 = cmk.heatmap(masks["materials"][:,:,1])
fig1 = cmk.heatmap(masks["targetsROI"])
fig2 = cmk.heatmap(X_full[:,:,100])

wavelengths = [0.417400, 0.421020, 0.424640, 0.428270, 0.431890, 0.435510, 0.439130, 0.442760, 0.446380, 0.450000, 0.453620, 0.457250, 0.460870, 0.464490, 0.468110, 0.471730, 0.475360, 0.478980, 0.482600, 0.486220, 0.489850, 0.493470, 0.497090, 0.500710, 0.504340, 0.507960, 0.511580, 0.515200, 0.518830, 0.522450, 0.526070, 0.529690, 0.533310, 0.536940, 0.540560, 0.544180, 0.547800, 0.551430, 0.555050, 0.558670, 0.562290, 0.565920, 0.569540, 0.573160, 0.576780, 0.580400, 0.584030, 0.587650, 0.591270, 0.594890, 0.598520, 0.602140, 0.605760, 0.609380, 0.613010, 0.616630, 0.620250, 0.623870, 0.627490, 0.631120, 0.634740, 0.638360, 0.641980, 0.645610, 0.649230, 0.652850, 0.656470, 0.660100, 0.663720, 0.667340, 0.670960, 0.674590, 0.678210, 0.681830, 0.685450, 0.689070, 0.692700, 0.696320, 0.699940, 0.703560, 0.707190, 0.710810, 0.714430, 0.718050, 0.721680, 0.725300, 0.728920, 0.732540, 0.736160, 0.739790, 0.743410, 0.747030, 0.750650, 0.754280, 0.757900, 0.761520, 0.765140, 0.768770, 0.772390, 0.776010, 0.779630, 0.783260, 0.786880, 0.790500, 0.794120, 0.797740, 0.801370, 0.804990, 0.808610, 0.812230, 0.815860, 0.819480, 0.823100, 0.826720, 0.830350, 0.833970, 0.837590, 0.841210, 0.844830, 0.848460, 0.852080, 0.855700, 0.859320, 0.862950, 0.866570, 0.870190, 0.873810, 0.877440, 0.881060, 0.884680, 0.888300, 0.891920, 0.895550, 0.899170, 0.902790] .* 1000

fwhm = [ 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004870, 0.004850, 0.004820, 0.004800, 0.004800, 0.004800, 0.004830, 0.004850, 0.004870,  0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004870, 0.004840, 0.004820, 0.004800, 0.004800, 0.004810, 0.004830, 0.004850, 0.004870, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004860, 0.004840, 0.004820, 0.004800, 0.004800, 0.004810, 0.004830, 0.004850, 0.004870, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004860, 0.004840, 0.004820, 0.004800, 0.004800, 0.004810, 0.004830, 0.004850, 0.004880, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004880, 0.004860, 0.004840, 0.004820, 0.004800, 0.004800, 0.004810, 0.004830, 0.004860, 0.004880, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004880, 0.004860, 0.004840, 0.004810, 0.004800, 0.004800, 0.004810, 0.004840, 0.004860, 0.004880, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004880, 0.004860, 0.004830, 0.004810, 0.004800, 0.004800, 0.004810, 0.004840, 0.004860, 0.004880, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004760, 0.004880, 0.004860, 0.004830, 0.004810, 0.004800]



data_out = h5open("./data/hysu/processed/data.h5", "w")

data_out["large"] = X_large;
data_out["small"] = X_small;
data_out["all"] = X_all;
data_out["full"] = X_full;
data_out["materials"] = masks["materials"];
data_out["targetsROI"] = masks["targetsROI"];
data_out["pixel_mask"] = Int8.(pixel_mask);
data_out["wavelengths"] = wavelengths;
data_out["fwhm"] = fwhm;

close(data_out)



# create dataframe from the "all", "large", and "small" datasets

λs = ["λ_"*lpad(i, 3, "0") for i ∈ 1:length(wavelengths)]

idxs = findall(pixel_mask)
X_all[:, idxs]

df_all = DataFrame(X_all[:, idxs]', λs);
CSV.write("./data/hysu/all.csv", df_all)

df_large = DataFrame(X_large[:,[CartesianIndex(i,j) for i ∈ axes(X_large,2) for j ∈ axes(X_large,3)]]', λs);
CSV.write("./data/hysu/large.csv", df_large)

df_small= DataFrame(X_small[:,[CartesianIndex(i,j) for i ∈ axes(X_small,2) for j ∈ axes(X_small,3)]]', λs);
CSV.write("./data/hysu/small.csv", df_small)



# create
ref_spec = [
    0.41740   644.0   461.0  1535.0   731.0   396.0   396.0   367.0
    0.42102   687.0   444.0  1548.0   689.0   396.0   396.0   323.0
    0.42464   684.0   436.0  1569.0   621.0   384.0   384.0   343.0
    0.42827   670.0   463.0  1656.0   597.0   408.0   408.0   352.0
    0.43189   689.0   431.0  1620.0   547.0   421.0   421.0   365.0
    0.43551   680.0   410.0  1704.0   542.0   417.0   417.0   356.0
    0.43913   695.0   404.0  1781.0   504.0   408.0   408.0   381.0
    0.44276   706.0   402.0  1788.0   477.0   411.0   411.0   387.0
    0.44638   685.0   388.0  1759.0   450.0   411.0   411.0   373.0
    0.45000   683.0   379.0  1712.0   437.0   402.0   402.0   379.0
    0.45362   680.0   372.0  1656.0   407.0   396.0   396.0   390.0
    0.45725   696.0   367.0  1668.0   391.0   411.0   411.0   391.0
    0.46087   693.0   356.0  1671.0   369.0   426.0   426.0   391.0
    0.46449   680.0   342.0  1614.0   346.0   443.0   443.0   385.0
    0.46811   671.0   337.0  1597.0   336.0   466.0   466.0   378.0
    0.47173   667.0   314.0  1605.0   329.0   497.0   497.0   385.0
    0.47536   676.0   310.0  1542.0   325.0   526.0   526.0   384.0
    0.47898   703.0   334.0  1550.0   326.0   575.0   575.0   409.0
    0.48260   696.0   326.0  1517.0   331.0   605.0   605.0   410.0
    0.48622   701.0   311.0  1450.0   318.0   632.0   632.0   401.0
    0.48985   691.0   313.0  1415.0   309.0   667.0   667.0   419.0
    0.49347   674.0   299.0  1373.0   304.0   687.0   687.0   418.0
    0.49709   689.0   294.0  1370.0   301.0   726.0   726.0   441.0
    0.50071   697.0   303.0  1358.0   300.0   767.0   767.0   468.0
    0.50434   691.0   300.0  1294.0   286.0   780.0   780.0   452.0
    0.50796   695.0   292.0  1255.0   291.0   813.0   813.0   473.0
    0.51158   695.0   302.0  1231.0   299.0   828.0   828.0   509.0
    0.51520   715.0   293.0  1201.0   301.0   860.0   860.0   550.0
    0.51883   705.0   279.0  1139.0   292.0   870.0   870.0   582.0
    0.52245   678.0   279.0  1094.0   294.0   844.0   844.0   605.0
    0.52607   698.0   290.0  1099.0   306.0   877.0   877.0   653.0
    0.52969   722.0   294.0  1094.0   311.0   883.0   883.0   713.0
    0.53331   714.0   297.0  1073.0   322.0   866.0   866.0   746.0
    0.53694   729.0   302.0  1048.0   324.0   872.0   872.0   784.0
    0.54056   733.0   295.0  1035.0   327.0   860.0   860.0   805.0
    0.54418   722.0   302.0  1016.0   336.0   841.0   841.0   826.0
    0.54780   715.0   298.0   967.0   343.0   821.0   821.0   836.0
    0.55143   720.0   298.0   957.0   358.0   795.0   795.0   835.0
    0.55505   731.0   309.0   948.0   371.0   778.0   778.0   854.0
    0.55867   736.0   315.0   939.0   401.0   771.0   771.0   865.0
    0.56229   733.0   321.0   900.0   427.0   733.0   733.0   848.0
    0.56592   725.0   337.0   884.0   456.0   698.0   698.0   839.0
    0.56954   731.0   370.0   898.0   519.0   684.0   684.0   812.0
    0.57316   736.0   409.0   876.0   575.0   666.0   666.0   804.0
    0.57678   734.0   476.0   865.0   653.0   645.0   645.0   775.0
    0.58040   745.0   559.0   863.0   760.0   630.0   630.0   777.0
    0.58403   734.0   663.0   856.0   896.0   609.0   609.0   761.0
    0.58765   735.0   794.0   870.0  1055.0   599.0   599.0   763.0
    0.59127   745.0   953.0   866.0  1235.0   573.0   573.0   756.0
    0.59489   737.0  1121.0   862.0  1450.0   559.0   559.0   754.0
    0.59852   738.0  1267.0   839.0  1700.0   533.0   533.0   755.0
    0.60214   743.0  1431.0   832.0  1972.0   516.0   516.0   743.0
    0.60576   745.0  1598.0   835.0  2275.0   507.0   507.0   746.0
    0.60938   732.0  1731.0   842.0  2597.0   490.0   490.0   747.0
    0.61301   732.0  1811.0   825.0  2941.0   489.0   489.0   729.0
    0.61663   731.0  1916.0   837.0  3315.0   479.0   479.0   725.0
    0.62025   739.0  1979.0   835.0  3668.0   474.0   474.0   727.0
    0.62387   744.0  2063.0   826.0  4038.0   474.0   474.0   740.0
    0.62749   741.0  2083.0   823.0  4390.0   476.0   476.0   741.0
    0.63112   742.0  2084.0   827.0  4711.0   464.0   464.0   712.0
    0.63474   732.0  2149.0   836.0  5042.0   471.0   471.0   708.0
    0.63836   732.0  2199.0   843.0  5359.0   473.0   473.0   711.0
    0.64198   737.0  2240.0   857.0  5658.0   466.0   466.0   689.0
    0.64561   753.0  2302.0   851.0  5926.0   469.0   469.0   688.0
    0.64923   757.0  2337.0   845.0  6161.0   476.0   476.0   685.0
    0.65285   743.0  2358.0   834.0  6289.0   474.0   474.0   686.0
    0.65647   729.0  2350.0   840.0  6347.0   472.0   472.0   653.0
    0.66010   716.0  2429.0   876.0  6470.0   486.0   486.0   640.0
    0.66372   723.0  2498.0   873.0  6644.0   491.0   491.0   640.0
    0.66734   732.0  2518.0   870.0  6723.0   484.0   484.0   622.0
    0.67096   729.0  2558.0   860.0  6797.0   465.0   465.0   625.0
    0.67459   723.0  2617.0   857.0  6873.0   462.0   462.0   627.0
    0.67821   724.0  2656.0   861.0  6891.0   458.0   458.0   641.0
    0.68183   710.0  2665.0   862.0  6902.0   471.0   471.0   652.0
    0.68545   719.0  2691.0   838.0  6962.0   466.0   466.0   675.0
    0.68907   729.0  2771.0   863.0  6965.0   491.0   491.0   738.0
    0.69270   724.0  2813.0   882.0  6977.0   537.0   537.0   846.0
    0.69632   726.0  2879.0   895.0  7115.0   552.0   552.0   991.0
    0.69994   735.0  2941.0   909.0  7117.0   557.0   557.0  1133.0
    0.70356   784.0  2907.0   910.0  7054.0   583.0   583.0  1312.0
    0.70719   755.0  2989.0   902.0  7128.0   591.0   591.0  1525.0
    0.71081   743.0  2979.0   904.0  7167.0   597.0   597.0  1652.0
    0.71443   750.0  2941.0   914.0  7191.0   593.0   593.0  1775.0
    0.71805   698.0  3041.0   899.0  7123.0   563.0   563.0  1913.0
    0.72168   701.0  2999.0   891.0  7196.0   583.0   583.0  2138.0
    0.72530   708.0  3037.0   932.0  7218.0   576.0   576.0  2228.0
    0.72892   697.0  3092.0   933.0  7235.0   568.0   568.0  2459.0
    0.73254   731.0  3122.0  1008.0  7272.0   619.0   619.0  2597.0
    0.73616   752.0  3134.0  1089.0  7362.0   634.0   634.0  2754.0
    0.73979   750.0  3141.0  1127.0  7297.0   664.0   664.0  2843.0
    0.74341   728.0  3126.0  1203.0  7298.0   724.0   724.0  2946.0
    0.74703   749.0  3148.0  1336.0  7307.0   776.0   776.0  3034.0
    0.75065   765.0  3171.0  1484.0  7336.0   799.0   799.0  3084.0
    0.75428   779.0  3226.0  1668.0  7377.0   843.0   843.0  3082.0
    0.75790   774.0  3235.0  1879.0  7420.0   876.0   876.0  3176.0
    0.76152   696.0  2921.0  1969.0  6982.0   835.0   835.0  3021.0
    0.76514   715.0  2939.0  2280.0  7052.0   895.0   895.0  3069.0
    0.76877   780.0  3136.0  2547.0  7378.0  1007.0  1007.0  3363.0
    0.77239   808.0  3204.0  2826.0  7533.0  1046.0  1046.0  3419.0
    0.77601   836.0  3184.0  3054.0  7603.0  1063.0  1063.0  3386.0
    0.77963   848.0  3186.0  3175.0  7620.0  1061.0  1061.0  3431.0
    0.78326   857.0  3171.0  3384.0  7600.0  1059.0  1059.0  3500.0
    0.78688   872.0  3086.0  3452.0  7616.0  1068.0  1068.0  3560.0
    0.79050   861.0  3085.0  3497.0  7694.0  1060.0  1060.0  3452.0
    0.79412   882.0  3044.0  3518.0  7638.0  1094.0  1094.0  3531.0
    0.79774   860.0  3036.0  3585.0  7607.0  1107.0  1107.0  3530.0
    0.80137   827.0  2963.0  3599.0  7673.0  1096.0  1096.0  3557.0
    0.80499   858.0  2901.0  3597.0  7571.0  1095.0  1095.0  3541.0
    0.80861   857.0  2914.0  3661.0  7475.0  1127.0  1127.0  3499.0
    0.81223   848.0  3002.0  3765.0  7527.0  1126.0  1126.0  3601.0
    0.81586   830.0  2934.0  3729.0  7571.0  1132.0  1132.0  3659.0
    0.81948   829.0  2916.0  3854.0  7639.0  1173.0  1173.0  3723.0
    0.82310   837.0  2865.0  3838.0  7622.0  1170.0  1170.0  3666.0
    0.82672   845.0  2949.0  3832.0  7713.0  1192.0  1192.0  3630.0
    0.83035   814.0  2865.0  3870.0  7536.0  1184.0  1184.0  3699.0
    0.83397   780.0  2799.0  3954.0  7453.0  1176.0  1176.0  3720.0
    0.83759   862.0  2787.0  3976.0  7543.0  1207.0  1207.0  3771.0
    0.84121   840.0  2793.0  4036.0  7595.0  1182.0  1182.0  3823.0
    0.84483   807.0  2811.0  4025.0  7622.0  1161.0  1161.0  3777.0
    0.84846   798.0  2905.0  4088.0  7679.0  1219.0  1219.0  3837.0
    0.85208   789.0  2915.0  4110.0  7679.0  1264.0  1264.0  3923.0
    0.85570   803.0  2774.0  4135.0  7599.0  1221.0  1221.0  3881.0
    0.85932   796.0  2742.0  4195.0  7530.0  1187.0  1187.0  3862.0
    0.86295   832.0  2822.0  4180.0  7849.0  1201.0  1201.0  3824.0
    0.86657   859.0  2832.0  4182.0  7755.0  1281.0  1281.0  3852.0
    0.87019   795.0  2812.0  4123.0  7685.0  1270.0  1270.0  3826.0
    0.87381   810.0  2851.0  4166.0  7739.0  1267.0  1267.0  3778.0
    0.87744   792.0  2837.0  4219.0  7737.0  1234.0  1234.0  3780.0
    0.88106   720.0  2824.0  4195.0  7639.0  1249.0  1249.0  3903.0
    0.88468   841.0  2799.0  4221.0  7695.0  1211.0  1211.0  4050.0
    0.88830   785.0  2751.0  4213.0  7683.0  1197.0  1197.0  3918.0
    0.89192   689.0  2604.0  4163.0  7777.0  1218.0  1218.0  3867.0
    0.89555   684.0  2616.0  4326.0  7892.0  1186.0  1186.0  3734.0
    0.89917   730.0  2556.0  4264.0  7656.0  1162.0  1162.0  3968.0
    0.90279   792.0  2708.0  4094.0  7679.0  1154.0  1154.0  4035.0
];


ref_svc = [
    0.41740   658.599365   390.404297  1589.254517   724.477112   323.655823   222.568924
    0.42102   662.962830   382.328979  1650.390381   661.871094   316.272736   231.895081
    0.42464   667.293823   373.795410  1695.875122   604.347412   312.268311   240.347260
    0.42827   671.942932   365.890076  1737.945801   553.158142   311.087646   247.967102
    0.43189   675.690857   356.134827  1775.074097   503.473083   312.504272   254.785355
    0.43551   680.297424   348.267487  1811.791992   462.206940   314.264801   260.356415
    0.43913   684.578430   338.904938  1855.462158   426.434418   316.164520   266.005890
    0.44276   688.267334   329.499237  1850.222412   395.029358   315.305450   271.899384
    0.44638   691.110168   320.738037  1826.525635   367.932526   314.773132   278.441071
    0.45000   694.299744   312.454468  1785.848022   344.776733   316.563538   285.220886
    0.45362   697.259888   305.160858  1761.554810   324.917084   323.574249   291.154633
    0.45725   698.981567   298.546783  1742.666992   307.382294   336.072815   296.125702
    0.46087   700.998596   292.240906  1733.469238   292.767578   357.297180   299.831879
    0.46449   702.801147   286.542206  1726.958496   280.502991   385.632507   303.225677
    0.46811   704.539185   279.560181  1713.536255   270.300354   420.803619   306.627380
    0.47173   705.436462   272.717102  1688.352417   261.272430   459.124054   309.808533
    0.47536   707.265503   266.335083  1653.670654   253.755234   499.394287   313.340973
    0.47898   709.214050   259.941589  1612.727539   247.513229   540.069946   317.518280
    0.48260   710.780396   255.002350  1571.774048   241.848907   578.312805   321.223022
    0.48622   713.125061   251.713577  1536.308594   237.776993   620.958313   325.942505
    0.48985   714.893433   248.485001  1495.350952   233.033081   655.261475   331.344421
    0.49347   717.255432   246.589294  1460.580322   229.246292   691.861755   338.615082
    0.49709   719.372498   245.531174  1427.432495   226.146912   728.371460   349.039703
    0.50071   722.143311   243.992508  1392.903076   223.954666   766.113037   363.349823
    0.50434   724.284119   242.050430  1353.454834   221.670044   797.751953   383.840881
    0.50796   727.089478   239.946045  1313.623047   220.918304   824.905823   410.920746
    0.51158   729.550537   237.304565  1273.205200   220.347870   847.723755   446.771606
    0.51520   732.016602   235.025208  1235.702515   220.571152   869.541016   493.093994
    0.51883   734.043579   232.478958  1198.007813   220.980087   885.962463   551.092407
    0.52245   736.536255   230.881546  1165.902954   222.386414   892.090149   613.771790
    0.52607   739.012024   230.777695  1139.406006   224.767838   897.971436   675.547241
    0.52969   740.526550   230.627289  1113.036499   227.462357   895.869141   731.882874
    0.53331   743.175476   232.175385  1089.196777   231.709152   891.087219   776.520081
    0.53694   744.730408   233.691711  1062.124023   236.667130   880.020203   809.875427
    0.54056   746.246582   234.939072  1036.703003   243.873581   866.613220   835.268372
    0.54418   747.687073   235.691666  1010.968506   252.545242   847.753235   858.878479
    0.54780   749.161682   237.746902   980.113098   264.866516   826.896667   877.277283
    0.55143   751.661194   240.776306   953.364563   279.176788   802.767395   894.656250
    0.55505   752.939941   245.589279   931.323486   298.517914   773.700867   905.987793
    0.55867   753.168701   253.375809   907.991394   322.978424   744.209595   898.108704
    0.56229   754.509216   266.666229   889.317078   354.978424   715.788025   882.027222
    0.56592   756.013000   287.602905   878.713501   395.557831   691.782959   859.822388
    0.56954   757.662292   321.002869   870.153442   448.157349   669.990234   829.535034
    0.57316   758.882446   371.251434   863.693542   516.767822   646.284546   796.423645
    0.57678   759.985657   442.344940   857.248413   604.583313   624.319336   766.970642
    0.58040   760.870911   536.408936   851.654785   716.683533   601.972778   741.990784
    0.58403   761.857544   654.738770   846.873901   855.003784   580.877747   722.851685
    0.58765   762.598389   799.014160   843.537231  1022.248657   560.758667   708.563904
    0.59127   762.543152   977.159851   838.494690  1230.780273   539.638428   696.980286
    0.59489   762.764099  1168.956665   833.882813  1470.000610   518.298340   689.834595
    0.59852   763.482239  1361.429565   829.796021  1744.398560   497.737671   685.784790
    0.60214   764.019531  1541.214966   826.183960  2056.569580   478.274902   681.009766
    0.60576   764.745789  1699.550171   821.996399  2401.602295   460.557190   672.836121
    0.60938   764.894897  1833.866577   819.009155  2775.824951   446.463348   660.018616
    0.61301   764.535034  1947.478394   816.840332  3179.227539   437.224274   644.191101
    0.61663   764.471008  2043.857910   816.243408  3611.436523   431.456360   628.433838
    0.62025   764.268005  2129.024170   815.846130  4075.206055   427.717163   615.008423
    0.62387   764.595154  2199.619629   815.963013  4537.589844   426.243896   607.067932
    0.62749   763.809570  2258.726074   816.693115  4985.856934   424.270416   603.194275
    0.63112   763.762634  2309.535889   815.675659  5414.333008   422.504517   601.778687
    0.63474   763.160339  2353.405518   815.258362  5813.865723   420.384644   597.226196
    0.63836   762.928162  2393.168701   815.725281  6168.171875   418.004150   584.013733
    0.64198   762.472534  2425.978271   816.379211  6474.486328   417.584503   564.787903
    0.64561   762.003052  2460.122559   818.202393  6741.260742   418.498108   543.880127
    0.64923   762.342896  2498.559814   825.606934  6981.097656   420.866730   527.096069
    0.65285   761.730957  2534.702393   831.659546  7189.015625   424.213959   514.916138
    0.65647   761.825806  2574.480713   841.391846  7367.705566   430.260742   505.417480
    0.66010   761.910034  2621.537354   852.466125  7526.411621   434.488342   494.302155
    0.66372   762.324402  2659.210938   856.550415  7650.586914   438.660370   478.684235
    0.66734   763.489990  2698.721680   857.090759  7751.119141   439.378754   466.566406
    0.67096   762.413818  2743.774170   852.076355  7842.971680   432.534637   460.865387
    0.67459   761.701294  2792.075928   839.188904  7930.356445   423.735657   460.749176
    0.67821   760.835876  2843.019043   832.635254  8007.777832   418.535278   465.345245
    0.68183   761.043518  2892.079102   834.296753  8057.121582   426.709991   477.939880
    0.68545   761.671021  2935.254395   845.087830  8094.057617   442.663544   508.054749
    0.68907   762.057617  2982.114502   856.298401  8133.930176   463.796783   574.112244
    0.69270   762.287842  3029.550049   864.286804  8167.354004   483.263245   682.710632
    0.69632   763.046570  3075.547119   867.947998  8201.225586   499.137665   848.395020
    0.69994   763.282837  3118.593750   867.504395  8231.093750   509.610474  1056.864990
    0.70356   763.277283  3161.960449   865.229431  8261.333984   517.355347  1293.117065
    0.70719   763.922302  3204.093506   863.850525  8289.129883   523.388977  1529.256958
    0.71081   764.532959  3242.965820   865.600281  8320.833008   529.057129  1764.772583
    0.71443   765.594482  3278.408447   873.403625  8350.142578   535.408569  2000.656372
    0.71805   766.026001  3309.615723   887.411499  8374.852539   545.584473  2240.142334
    0.72168   764.663391  3339.997803   903.672607  8411.078125   552.204041  2509.356934
    0.72530   766.966675  3364.780518   927.459473  8431.571289   566.580811  2752.616943
    0.72892   766.959839  3384.716797   956.452026  8452.110352   582.362610  2991.110840
    0.73254   767.703125  3399.292480   992.994080  8472.765625   602.174988  3208.665039
    0.73616   768.592102  3409.070313  1039.417847  8484.059570   626.300537  3391.768799
    0.73979   769.064636  3415.624023  1099.850830  8495.144531   655.612427  3548.485596
    0.74341   769.569946  3415.320801  1182.088623  8506.945313   687.456787  3677.441406
    0.74703   770.242615  3412.777344  1292.159668  8516.137695   725.295166  3778.353271
    0.75065   771.027222  3407.541748  1439.389282  8524.650391   766.374756  3858.242676
    0.75428   770.981262  3397.718750  1622.941528  8534.417969   807.338806  3921.378418
    0.75790   772.896179  3388.617920  1821.304565  8546.060547   843.593567  3973.149170
    0.76152   776.716125  3378.969482  2044.856445  8557.756836   887.006226  4022.447998
    0.76514   766.868896  3354.976318  2316.411865  8589.315430   906.400879  4054.941650
    0.76877   769.662964  3338.616455  2531.314453  8592.932617   925.356506  4079.904297
    0.77239   772.488220  3319.794922  2716.948975  8590.649414   943.721436  4102.486816
    0.77601   772.471802  3295.654297  2879.109863  8588.804688   953.251465  4120.951660
    0.77963   771.937744  3270.247803  3017.620361  8592.326172   961.518616  4140.896973
    0.78326   772.958069  3247.043945  3135.090088  8600.941406   967.758423  4162.822754
    0.78688   773.798950  3223.033691  3236.008057  8611.077148   975.314636  4184.893555
    0.79050   772.860779  3199.074463  3319.346191  8619.377930   981.845093  4204.614746
    0.79412   772.656982  3171.481201  3389.549316  8622.051758   990.881287  4221.982422
    0.79774   772.101379  3145.686279  3447.374756  8621.041016  1000.972473  4238.968262
    0.80137   773.003723  3115.580322  3497.760742  8622.606445  1009.788208  4253.831543
    0.80499   770.546692  3091.807373  3539.550293  8625.285156  1021.210693  4272.001953
    0.80861   772.829834  3069.985596  3582.975830  8637.833008  1033.327026  4293.602539
    0.81223   772.169250  3052.327881  3623.580811  8647.563477  1045.721436  4314.325195
    0.81586   774.678284  3030.482422  3658.299072  8656.600586  1055.888794  4330.502441
    0.81948   772.407715  3007.578613  3688.367188  8672.816406  1066.177124  4351.319336
    0.82310   772.773987  2991.227783  3724.738281  8679.085938  1074.751831  4368.144531
    0.82672   772.967163  2970.880859  3753.577637  8691.958008  1083.344604  4391.558594
    0.83035   775.778503  2956.714600  3782.323486  8698.747070  1096.483521  4407.507813
    0.83397   773.446716  2939.403076  3804.613525  8702.877930  1103.278442  4424.136719
    0.83759   774.063293  2922.253174  3826.868896  8706.787109  1110.305298  4442.341797
    0.84121   776.208252  2907.484375  3846.152588  8706.532227  1118.334839  4457.952637
    0.84483   774.697205  2897.570068  3859.863037  8703.796875  1125.609741  4471.907227
    0.84846   775.661499  2881.953369  3877.691895  8703.702148  1126.903198  4486.448242
    0.85208   777.911743  2873.924561  3890.307129  8705.345703  1134.681396  4501.264160
    0.85570   774.592651  2863.812988  3902.187988  8698.683594  1135.185913  4516.382813
    0.85932   774.678406  2853.238037  3911.287354  8692.233398  1141.493896  4530.320313
    0.86295   776.944336  2847.698486  3925.972656  8679.980469  1141.954956  4544.406738
    0.86657   774.732239  2844.552490  3935.957520  8686.697266  1150.759766  4556.750000
    0.87019   772.805786  2839.791016  3950.445313  8710.602539  1146.530396  4574.642578
    0.87381   774.893066  2839.291260  3961.044678  8716.023438  1154.277100  4589.006836
    0.87744   773.839722  2834.805420  3970.030029  8711.505859  1148.427612  4595.499023
    0.88106   776.023560  2832.587891  3974.551758  8707.236328  1152.647583  4607.199707
    0.88468   772.449097  2830.442627  3981.878174  8711.014648  1153.194946  4622.224609
    0.88830   774.426575  2836.047607  3991.504639  8713.507813  1159.540527  4634.618652
    0.89192   775.116882  2836.979980  3990.420166  8710.925781  1158.657959  4645.313965
    0.89555   775.227051  2835.008301  3990.920166  8687.375000  1162.677490  4641.010254
    0.89917   771.925415  2842.371094  3973.737549  8664.877930  1154.948242  4634.695313
    0.90279   771.887512  2829.812988  3967.884521  8662.992188  1151.420410  4642.164551
];


ref_spec[:,2:end]  .= ref_spec[:, 2:end] ./ 10_000
ref_svc[:,2:end]  .= ref_svc[:, 2:end] ./ 10_000


df_ref = DataFrame(ref_spec, [:λ, :bitumen, :red_metal, :blue_fabric, :red_fabric, :green_fabric, :green_fabric_2, :grass])
df_ref.λ .= df_ref.λ .* 1000
df_ref
CSV.write("./data/hysu/reference-spectra.csv", df_ref)

df_svc = DataFrame(ref_svc, [:λ, :bitumen, :red_metal, :blue_fabric, :red_fabric, :green_fabric, :grass])
df_svc.λ .= df_svc.λ .* 1000
CSV.write("./data/hysu/svc-spectra.csv", df_svc)




